

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> backend/controllers/streamController.js</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="./build/entry.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
             
                <a href="index.html">
                    <h1 class="navbar-item">SiincTv</h1>
                </a>
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    API Documentation
                </a>
                
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Global</h3><ul><li><a href="global.html#addNotificationToFollowersOf">addNotificationToFollowersOf</a></li><li><a href="global.html#bcrypt">bcrypt</a></li><li><a href="global.html#emitNewStreamerJoined">emitNewStreamerJoined</a></li><li><a href="global.html#emitReloadNotifications">emitReloadNotifications</a></li><li><a href="global.html#emitToUser">emitToUser</a></li><li><a href="global.html#express">express</a></li><li><a href="global.html#FriendFinder">FriendFinder</a></li><li><a href="global.html#FriendRequestAccepted">FriendRequestAccepted</a></li><li><a href="global.html#FriendRequestReceived">FriendRequestReceived</a></li><li><a href="global.html#generateKey">generateKey</a></li><li><a href="global.html#handleFollowRequest">handleFollowRequest</a></li><li><a href="global.html#handleFriendsRequest">handleFriendsRequest</a></li><li><a href="global.html#JoinStreamRequestNotification">JoinStreamRequestNotification</a></li><li><a href="global.html#JoinStreamRequestResponse">JoinStreamRequestResponse</a></li><li><a href="global.html#NewFollowerNotification">NewFollowerNotification</a></li><li><a href="global.html#NewLiveStream">NewLiveStream</a></li><li><a href="global.html#NewScheduledStream">NewScheduledStream</a></li><li><a href="global.html#NewStreamFollowNotification">NewStreamFollowNotification</a></li><li><a href="global.html#NotificationMenu">NotificationMenu</a></li><li><a href="global.html#StreamDatePicker">StreamDatePicker</a></li><li><a href="global.html#StreamDetails">StreamDetails</a></li><li><a href="global.html#StreamerCircle">StreamerCircle</a></li><li><a href="global.html#Streamers">Streamers</a></li><li><a href="global.html#streamGroup">streamGroup</a></li><li><a href="global.html#StreamSelector">StreamSelector</a></li><li><a href="global.html#TeamBlock">TeamBlock</a></li><li><a href="global.html#user">user</a></li><li><a href="global.html#UserPreview">UserPreview</a></li></ul></div><div class="category"><h2>Backend</h2><h3>Modules</h3><ul><li><a href="module-NotificationController.html">NotificationController</a></li><li><a href="module-StreamController.html">StreamController</a></li><li><a href="module-TwitchController.html">TwitchController</a></li><li><a href="module-UserController.html">UserController</a></li><li><a href="module-YoutubeController.html">YoutubeController</a></li></ul><h3>Classes</h3><ul><li><a href="facebookData.html">facebookData</a></li><li><a href="followData.html">followData</a></li><li><a href="friendsData.html">friendsData</a></li><li><a href="googleData.html">googleData</a></li><li><a href="notification.html">notification</a></li><li><a href="notificationData.html">notificationData</a></li><li><a href="registeredViewerData.html">registeredViewerData</a></li><li><a href="streamData.html">streamData</a></li><li><a href="streamerData.html">streamerData</a></li><li><a href="twitchData.html">twitchData</a></li><li><a href="upComingEventData.html">upComingEventData</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>backend/controllers/streamController.js</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 *This controller is in charge of handling requests relating to streams
 * @module StreamController
 * @category Backend
 */

const {
  StreamData,
  StreamerData,
  streamGroup,
} = require("../models/streamModels");
const { User, Notification } = require("../models/user");
var ObjectID = require("mongodb").ObjectID;
var notificationController = require("../controllers/notificationController");
var followController = require("../controllers/followController");
const {
  emitReloadNotifications,
  emitNewStreamerJoined,
} = require("../sockets/sockets");
const NodeCache = require("node-cache");
const myCache = new NodeCache({ stdTTL: 120, checkperiod: 60 });

/**
 * Tries to create a new stream using the streamData and redirects to newly created page upon success
 * Note: This will fail if now user is signed in/ or the user already has a current stream
 * It adds a new stream to the current user, adds the stream to the database, and notifies all the user's followers
 * That he created a new stream.
 *
 * @param {*} req.body the stream Data
 */
exports.createStream = function (req, res) {
  // We can't allow stream creation for a non logged in user
  if (!req.user) {
    res.send("user/not_logged_in");
    console.log("no user");
  }
  const data = req.body;

  // Create the new stream data
  let streamData = new StreamData({
    date: new Date() /*data.date*/,
    name: data.name,
    status: data.status,
    privateStream: data.privateStream,
    joinOnly: data.inviteOnly,
    tags: data.tags ? data.tags.map((tag) => tag.value) : [],
    description: data.description,
    registeredViewers: null,
    numOfViewers: 0,
  });
  // set the creator object
  streamData.creator = new StreamerData({
    memberId: req.user._id,
    displayName: data.creator.displayName,
    userImage: data.creator.userImage,
    youtubeId: data.creator.youtubeId,
  });

  // We need to change the format of groups from the received format to the one we store
  // We map every group to a group of StreamerData
  const streamGroups = data.streamGroups.map((streamGroup) =>
    streamGroup.group.map(
      (member) =>
        new StreamerData({
          // Note: member id and userImage will need to change frontend side when friends are implemented
          // memberId: member.memberId,
          displayName: member.displayName,
          userImage: member.userImage,
          youtubeId: member.youtubeId,
        })
    )
  );
  streamData.streamGroups = streamGroups;
  // Save the new streamData
  streamData.save();
  // Update the user's current events
  User.updateOne(
    { _id: req.user._id },
    {
      $push: {
        upcomingEvents: {
          name: data.name,
          date: data.date,
          eventId: streamData._id,
        },
      },
    }
  ).then((obj) => {
    console.log("Object modified", obj);
  });
  // If it's live we set it to the current stream
  if (data.status === "Live") {
    User.updateOne(
      { _id: req.user._id },
      {
        $set: {
          currentStream: {
            name: data.name,
            date: data.date,
            eventId: streamData._id,
          },
        },
      }
    ).then((obj) => {
      console.log("Object modified", obj);
    });
  }
  console.log(req.user._id);

  // send notifications to all followers
  const notificationData = new Notification({
    type: "followStartedStream",
    clearable: true,
    data: {
      userId: req.user._id,
      username: req.user.username,
      userImage: req.user.userImage,
      streamId: streamData._id,
    },
  });
  followController.addNotificationToFollowersOf(
    req.user._id,
    notificationData,
    req.user.username + " started a new stream"
  );

  res.send(streamData._id);
};

/**
 * @brief finds stream data by id if it exists
 *
 * @param {*} req.body.streamId the id of the stream
 */
exports.getStreamById = function (req, res) {
  if (!req.body) {
    res.send("stream/invalid_id");
  }
  const id = req.body.streamId;
  console.log(id);
  StreamData.findById(id, async function (err, doc) {
    if (err) {
      console.log("Couldn't find this id");
    }
    // id exists
    if (doc) res.send(doc);
    else res.send("stream/invalid_id");
  });
};

/**
 * Searches all streams split to pages by a search string
 * Searches tags/description/name
 *
 * @param {*} req.body.searchString string to search
 * @param {*} req.body.page what page to request
 * @param {*} req.body.status stream status
 */
exports.searchStreams = function (req, res) {
  const page = req.body.page;
  const searchString = req.body.searchString;
  const status = req.body.status;
  const PAGE_SIZE = 20; // Similar to 'limit'
  const skip = (page - 1) * PAGE_SIZE; // For page 1, the skip is: (1 - 1) * 20 => 0 * 20 = 0
  StreamData.find(
    { $and: [{ $text: { $search: searchString } }, { status: status }] },
    { score: { $meta: "textScore" } }
  )
    .limit(PAGE_SIZE)
    .skip(skip)
    .exec(async function (err, result) {
      if (err) {
        console.log(err);
        console.log("stream/no_results");
      }
      // id exists
      if (result) res.send(result);
      else res.send("stream/no_results");
    });
};

/**
 * Finds all streams with a given status
 *
 * @param {*} req.body.page what page to request
 * @param {*} req.body.status stream status
 */
exports.getStreamsByStatus = function (req, res) {
  const page = req.body.page;
  const status = req.body.status;
  const PAGE_SIZE = 10; // Similar to 'limit'
  const skip = (page - 1) * PAGE_SIZE; // For page 1, the skip is: (1 - 1) * 20 => 0 * 20 = 0
  StreamData.find({ $and: [{ status: status }] })
    .limit(PAGE_SIZE)
    .skip(skip)
    .sort("-numOfViewers")
    .exec(async function (err, result) {
      if (err) {
        console.log(err);
        console.log("stream/no_results");
      }
      // id exists
      if (result) res.send(result);
      else res.send("stream/no_results");
    });
};

/**
 * Closes the user's stream if one exists (and if user exists)
 */
exports.closeStream = function (req, res) {
  const user = req.user;
  const streamId = user.currentStream ? user.currentStream.eventId : null;
  console.log(user.currentStream);
  if (streamId == null) {
    res.send("/stream/no_current_stream");
  }
  console.log(streamId);
  StreamData.deleteOne({ _id: new ObjectID(streamId) }, function (err) {
    console.log("could not remove current stream");
  });

  User.updateOne({ _id: req.user._id }, { $unset: { currentStream: "" } }).then(
    (obj) => {
      console.log("Object modified", obj);
    }
  );
};

/**
 * Sends a request from currently logged in user to join a stream
 * Note: Requests are cached and are limited to one request per user every 2 minutes
 *
 * @param {*} req.body.data formatted data of the current user (which is verified in the backend)
 * @param {*} req.body.creatorId Id of the creator to send request to
 * @return string describing error if failed, otherwise a request is sent
 */
exports.requestToJoinStream = function (req, res) {
  const user = req.user;
  const creatorId = req.body.creatorId;
  data = req.body.data;
  if (myCache.has(String(user._id))) {
    emitReloadNotifications(
      user._id,
      `Please wait two minutes between requests.`
    );
    res.send("wait between requests");
    return;
  }
  if (!user || !creatorId) {
    res.send("error");
    return;
  }

  streamerData = new StreamerData({
    memberId: user._id,
    displayName: data.displayName,
    userImage: data.userImage,
    youtubeId: data.youtubeId,
    twitchId: data.twitchId,
  });

  const notificationData = new Notification({
    type: "joinStreamRequest",
    clearable: false,
    data: streamerData,
  });

  myCache.set(String(user._id));
  notificationController.addNotificationToUser(
    creatorId,
    notificationData,
    `${user.username} wants to stream with you.`
  );
};

/**
 * Rejects a request to join stream from a user
 * @param {*} req.body.data data of the request we want to reject
 */
exports.rejectRequestToJoin = function (req, res) {
  const user = req.user;
  const data = req.body.data;
  console.log(req.body);
  const fromId = data.memberId;
  const notificationId = req.body._id;

  if (!user || !fromId || !notificationId) {
    res.send("error");
    return;
  }
  // Remove the notification from the user
  console.log("id is", user._id);
  console.log("notification id is ", notificationId);
  notificationController.deleteNotificationFromUser(user._id, notificationId);

  streamerData = new StreamerData({
    memberId: data.memberId,
    displayName: data.displayName,
    userImage: data.userImage,
    youtubeId: data.youtubeId,
    twitchId: data.twitchId,
  });

  notificationData = new Notification({
    type: "rejectJoinStreamRequest",
    clearable: true,
    data: streamerData,
  });
  // Notify the requester the his request has been rejected
  notificationController.addNotificationToUser(
    fromId,
    notificationData,
    `${user.username} declined your request to join the stream.`
  );
};

/**
 * @brief Adds a streamer to the stream with stream id and emits a refresh to all the viewers
 * @param {*} streamId id of the streamer
 * @param {*} streamerData data of the streamer
 */
function addStreamer(streamId, streamerData) {
  if (!streamId || !streamerData) {
    return;
  }
  const newGroup = [streamerData];
  StreamData.updateOne(
    { _id: new ObjectID(streamId) },
    { $push: { streamGroups: newGroup } }
  ).then((obj) => {
    console.log(obj);
    emitNewStreamerJoined(streamId);
  });
}

/**
 * Rejects a request to join stream from a user
 * @param {*} req.body.data data of the request we want to reject
 */
exports.acceptRequestToJoin = function (req, res) {
  const user = req.user;
  const data = req.body.data;
  const streamId = user.currentStream.eventId;
  const fromId = data.memberId;
  const notificationId = req.body._id;

  if (!user || !fromId || !notificationId) {
    res.send("error");
    return;
  }
  // Remove the notification from the user
  console.log("id is", user._id);
  console.log("notification id is ", notificationId);
  console.log("stream id is ", streamId);
  notificationController.deleteNotificationFromUser(user._id, notificationId);

  streamerData = new StreamerData({
    memberId: data.memberId,
    displayName: data.displayName,
    userImage: data.userImage,
    youtubeId: data.youtubeId,
    twitchId: data.twitchId,
  });

  notificationData = new Notification({
    type: "acceptJoinStreamRequest",
    clearable: true,
    data: streamerData,
  });
  // Notify the requester the his request has been rejected

  notificationController.addNotificationToUser(
    fromId,
    notificationData,
    `${user.username} accepted your request to join the stream.`
  );
  console.log("here");
  // Add the streamer to the stream
  addStreamer(streamId, streamerData);
};
</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by 
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>

</body>
</html>
